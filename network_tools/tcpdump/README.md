# tcpdump 命令用法及输出说明

tcpdump 是一个强大的命令行网络抓包工具，用于捕获和分析网络流量。下面是它的主要用法和输出说明。

## 基本用法

```bash
tcpdump [选项] [表达式]
```

## 常用选项

| 选项 | 说明 |
|------|------|
| `-i <接口>` | 指定网络接口，如 `-i eth0` |
| `-n` | 不将地址解析为主机名 |
| `-nn` | 不解析主机名和端口名 |
| `-X` | 以十六进制和ASCII格式显示数据包内容 |
| `-XX` | 同 `-X`，但还包括以太网头部 |
| `-v` | 详细输出 |
| `-vv` | 更详细输出 |
| `-vvv` | 最详细输出 |
| `-c <数量>` | 捕获指定数量的数据包后退出 |
| `-s <长度>` | 设置捕获的数据包长度 |
| `-w <文件>` | 将捕获的数据包写入文件 |
| `-r <文件>` | 从文件中读取数据包 |
| `-A` | 以ASCII格式显示数据包内容 |
| `-q` | 快速(安静)输出 |
| `-t` | 不打印时间戳 |
| `-e` | 显示链路层头部信息 |

## 过滤表达式

tcpdump 使用 Berkeley Packet Filter (BPF) 语法进行过滤：

### 基本类型

- `host <主机>`：过滤特定主机的流量
- `net <网络>`：过滤特定网络的流量
- `port <端口>`：过滤特定端口的流量
- `portrange <起始端口>-<结束端口>`：过滤端口范围

### 协议

- `tcp`
- `udp`
- `icmp`
- `arp`
- `ip`
- `ip6`

### 方向

- `src`：源
- `dst`：目的

### 逻辑运算符

- `and` 或 `&&`
- `or` 或 `||`
- `not` 或 `!`

## 示例命令

1. 捕获所有经过 eth0 接口的数据包：
   ```bash
   tcpdump -i eth0
   ```

2. 捕获特定主机的数据包：
   ```bash
   tcpdump host 192.168.1.1
   ```

3. 捕获源或目的为特定主机的数据包：
   ```bash
   tcpdump src host 192.168.1.1 or dst host 192.168.1.2
   ```

4. 捕获特定端口的数据包：
   ```bash
   tcpdump port 80
   ```

5. 捕获 HTTP GET 请求：
   ```bash
   tcpdump -s 0 -A 'tcp[((tcp[12:1] & 0xf0) >> 2):4] = 0x47455420'
   ```

6. 将捕获结果保存到文件：
   ```bash
   tcpdump -w capture.pcap
   ```

## 输出说明

典型的 tcpdump 输出如下：

```
15:04:23.123456 IP 192.168.1.100.54321 > 192.168.1.1.80: Flags [S], seq 123456789, win 65535, options [mss 1460], length 0
```

各部分含义：

1. **时间戳**：`15:04:23.123456`（时:分:秒.微秒）
2. **协议**：`IP`（也可以是 TCP, UDP, ICMP 等）
3. **源地址和端口**：`192.168.1.100.54321`
4. **方向**：`>` 表示流向
5. **目的地址和端口**：`192.168.1.1.80`
6. **TCP标志**：`Flags [S]`（S=SYN, F=FIN, P=PSH, R=RST, ACK=确认）
7. **序列号**：`seq 123456789`
8. **窗口大小**：`win 65535`
9. **选项**：`options [mss 1460]`（最大分段大小）
10. **数据长度**：`length 0`

## 高级用法

1. 组合过滤：
   ```bash
   tcpdump -i eth0 'tcp port 80 and (src host 192.168.1.100 or dst host 192.168.1.100)'
   ```

2. 捕获特定大小的数据包：
   ```bash
   tcpdump greater 1000
   tcpdump less 512
   ```

3. 捕获特定TCP标志的数据包：
   ```bash
   tcpdump 'tcp[tcpflags] & (tcp-syn|tcp-ack) != 0'
   ```

tcpdump 功能非常强大，以上只是基本用法。要了解更多细节，可以参考 `man tcpdump` 或在线文档。
