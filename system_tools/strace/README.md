# strace 命令用法及输出说明

`strace` 是 Linux 系统中用于跟踪进程执行时调用的**系统调用（system calls）**和接收的**信号（signals）**的强大工具。它可以帮助开发者调试程序、分析性能瓶颈或理解程序与操作系统内核的交互。

---

### **基本用法**
```bash
strace [options] <command>      # 跟踪新启动的命令
strace -p <PID>                 # 跟踪正在运行的进程
```

---

### **常用选项**
| 选项 | 说明 |
|------|------|
| `-p <PID>` | 附加到正在运行的进程 |
| `-f`       | 跟踪子进程（fork/clone 创建的进程） |
| `-e <expr>` | 过滤系统调用（如 `-e open,read`） |
| `-o <file>` | 将输出写入文件 |
| `-c`       | 统计系统调用耗时和次数 |
| `-s <size>` | 限制打印字符串的长度（默认 32） |
| `-tt`      | 显示精确到微秒的时间戳 |
| `-T`       | 显示每个系统调用的耗时 |
| `-y`       | 打印文件描述符对应的路径 |

---

### **输出字段说明**
每行输出通常包含以下部分：
```bash
execve("/bin/ls", ["ls"], 0x7ffd3a3b2d80 /* 50 vars */) = 0
```
1. **系统调用名称**（如 `execve`）
2. **参数列表**（括号内，如 `"/bin/ls"` 是程序路径）
3. **返回值**（`= 0` 表示成功，负数表示错误）

---

### **常见系统调用示例**
| 系统调用 | 说明 |
|----------|------|
| `read(fd, buf, size)` | 从文件描述符读取数据 |
| `write(fd, buf, size)` | 写入数据到文件描述符 |
| `open(path, flags)` | 打开文件 |
| `close(fd)` | 关闭文件描述符 |
| `fork()`/`clone()` | 创建子进程 |
| `execve()` | 执行新程序 |
| `stat()` | 获取文件状态 |
| `mmap()` | 内存映射 |

---

### **实战示例**
1. **跟踪 `ls` 命令的执行**：
   ```bash
   strace ls /tmp
   ```

2. **统计系统调用耗时**：
   ```bash
   strace -c ls /tmp
   ```

3. **跟踪网络相关调用**：
   ```bash
   strace -e connect,accept,recvfrom nc example.com 80
   ```

4. **跟踪已运行进程（如 PID=1234）**：
   ```bash
   strace -p 1234 -o debug.log
   ```

5. **显示文件描述符路径**（调试文件操作）：
   ```bash
   strace -y cat /etc/passwd
   ```

---

### **输出分析技巧**
- **错误排查**：查找返回值 `= -1` 和错误原因（如 `ENOENT` 表示文件不存在）。
- **性能分析**：结合 `-T` 或 `-c` 查看耗时长的调用。
- **文件操作**：用 `-e open,read,write` 过滤文件相关调用。
- **信号跟踪**：观察进程如何处理 `SIGSEGV`（段错误）等信号。

---

### **注意事项**
1. `strace` 会显著降低程序性能（因需拦截所有系统调用）。
2. 对生产环境谨慎使用，建议在测试环境调试。
3. 复杂程序建议结合 `-f` 跟踪子进程，或使用 `-tt` 记录时间顺序。

通过 `man strace` 可查看完整手册。
